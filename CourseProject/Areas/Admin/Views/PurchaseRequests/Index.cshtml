@using System.Web.Mvc.Ajax
@model IEnumerable<PurchaseRequest>

@{
    ViewData["Title"] = "Purchase requests";
}

<h1>Requests</h1>

<table class="table" id="requests-table">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Id)
            </th>
            <th>
                Car
            </th>
            <th>
                @Html.DisplayNameFor(model => model.FullName)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Email)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Phone)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ApplicationDate)
            </th>
            <td>
                @Html.DisplayNameFor(model => model.CarAvailability)
            </td>
            <th>
                @Html.DisplayNameFor(model => model.State)
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.Id)
            </td>
            <td>
                @item.Car.Model.Brand.Name @item.Car.Model.Parent?.Name @item.Car.Model.Name
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.FullName)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Phone)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Email)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ApplicationDate)
            </td>
            <td>
                @(item.CarAvailability ? "Yes" : "No")
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.State)
            </td>
            <td>
                
                @if (item.State == PurchaseRequest.RequestState.New) {
                    <button class="btn btn-primary btn-assign" data-id="@item.Id">Assign myself</button>
                }
                
                @if (!string.IsNullOrEmpty(item.ManagerId) && ViewBag.ManagerId == item.ManagerId) {
                    <a asp-action="Details" asp-route-id="@item.Id">Details</a>
                }

                @*<div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton-@item.Id" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        @Html.DisplayFor(modelItem => item.State)
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton-@item.Id">
                        @foreach (var elem in ViewBag.PurchaseRequestStates) {
                            <button class="dropdown-item" data-id="@item.Id" data-state="@elem.Key">@elem.Value</button>
                        }
                    </div>
                </div>*@
            </td>
        </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(() => {

            $('#requests-table').on('click',
                '.btn-assign',
                (e) => {
                    console.log(e.target);

                    const requestId = e.target.dataset['id'];

                    $.ajax({
                        url: '@Url.Action("AssignManagerToRequest", "PurchaseRequests")',
                        data: {requestId: requestId}
                    }).done((data) => {
                        console.log(data); 
                        $(e.target).text('Assigned');
                        $(e.target).before(`<a href="@Url.Action("Details")?id=${requestId}">Details</a>`);
                        $(e.target.parentNode).prev().text('Processing');
                        $(e.target).remove();
                    });
                });


            @*$('#requests-table').on('click',
                '.dropdown-item',
                (e) => {
                    console.log(e.target);

                    const requestId = e.target.dataset['id'];
                    const newState = e.target.dataset['state'];

                    $.ajax({
                        url: '@Url.Action("ChangeRequestState", "PurchaseRequests")',
                        data: {requestId: requestId, newState: newState}
                    }).done((data) => {
                        console.log(data);
                        $(`#dropdownMenuButton-${requestId}`).text(data);
                    });
                });*@
        });
    </script>
}